# CloudWatch Logs Handler — 設計ドキュメント

> 作成日: 2026-02-19

## 1. 背景・課題

- AWS上の1つのアカウントに**複数プロジェクト**が存在
- それらが**同じロググループ**にログを出力している
- ログストリーム名にプロジェクト識別子が含まれるが、ログ本文には含まれない
- 各プロジェクトごとに**特定のキーワードを監視**し、Slackに通知したい

## 2. 要件

- Lambda（Python）でログ監視を実現
- 1つのLambdaで複数プロジェクトの監視キーワードに対応
- 検知したログを **AWS SNS → Chatbot → Slack** で通知
- 通知内容・通知先をカスタマイズ可能
- 検知設定を **JSON** で管理
- キーワード検出頻度を**メトリクスとして可視化**（CloudWatch ダッシュボード）
- **重複通知の抑制**：同一キーワードが5分間に複数回検出されても通知は1回だけ（CloudWatch Alarm の OK → ALARM 遷移を活用）

## 3. 検討した代替案

| 方法 | プロジェクト識別 | メトリクス可視化 | 重複抑制 | 採否 |
|------|:---:|:---:|:---:|:---:|
| サブスクリプションフィルター + Lambda | ✅ | ❌ (自前) | ❌ (自前) | ❌ フィルターパターンが肥大化、コスト高 |
| メトリクスフィルター直接設定 | ❌ | ✅ | ✅ | ❌ ストリーム名で絞り込めない |
| Logs Insights + 直接通知 | ✅ | ❌ | ❌ (自前) | ❌ 可視化・重複抑制が不足 |
| ロググループ分離（根本対策） | ✅ | ✅ | ✅ | ⏳ 将来実施予定 |
| Contributor Insights | ✅ | ✅ | ❌ | ❌ アラート機能不足 |
| 外部転送（Kinesis → OpenSearch） | ✅ | ✅ | ✅ | ❌ オーバーキル |
| **formatter + messager（採用）** | ✅ | ✅ | ✅ | ✅ |

### 採用理由

- ログストリーム名でしかプロジェクトを識別できない制約下で、**メトリクス可視化**と**アラーム状態管理（重複抑制）**を両立できる唯一の方法
- 将来のロググループ分離後も **messager をそのまま活用可能**

## 4. アーキテクチャ

### 4.1 全体構成図

```
┌──────────────────────────────────────────────────────────────┐
│                  EventBridge (5分間隔)                        │
│                        │                                     │
│                        ▼                                     │
│              ┌──────────────────┐                            │
│              │  formatter Lambda │                           │
│              │  ・ログ検索        │                           │
│              │  ・キーワード検出   │                           │
│              │  ・結果をログ出力   │                           │
│              └────────┬─────────┘                            │
│                       ▼                                      │
│          ┌────────────────────────┐                          │
│          │  formatter ロググループ  │                          │
│          │  ┌──────────────────┐  │                          │
│          │  │メトリクスフィルター  │  │                          │
│          │  │(project × keyword)│  │                          │
│          │  └────────┬─────────┘  │                          │
│          └───────────┼───────────┘                          │
│                      ▼                                       │
│          ┌────────────────────────┐                          │
│          │  CloudWatch Alarm      │                          │
│          │  (閾値: ≥ 1)           │── ダッシュボード表示       │
│          │  OK → ALARM で発火     │                          │
│          └────────┬───────────── ┘                          │
│                   ▼                                          │
│          ┌──────────────────┐                                │
│          │  messager Lambda  │                                │
│          │  ・対象ログ再取得   │                                │
│          │  ・通知内容整形     │                                │
│          └────────┬─────────┘                                │
│                   ▼                                          │
│          SNS → Chatbot → Slack                               │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 将来の移行パス（ロググループ分離後）

```
【現在】                              【将来（分離後）】

 共有ロググループ                      プロジェクトA ロググループ
      │                                    │
      ▼                              メトリクスフィルター（直接設定）
 formatter Lambda                          │
      │                                    ▼
      ▼                              CloudWatch Alarm
 formatter ロググループ                     │
      │                                    ▼
 メトリクスフィルター                  messager Lambda ← 変更なし！
      │                                    │
      ▼                                    ▼
 CloudWatch Alarm                    SNS → Chatbot → Slack
      │
      ▼
 messager Lambda
      │
      ▼
 SNS → Chatbot → Slack
```

**段階的移行**が可能：

1. **Step 1（現在）**: formatter + messager で全プロジェクト監視
2. **Step 2（一部分離）**: 分離済みプロジェクトは直接メトリクスフィルター、未分離は formatter 経由
3. **Step 3（全分離完了）**: formatter を廃止、messager はそのまま稼働

## 5. コンポーネント詳細

### 5.1 formatter Lambda

**役割**: 共有ロググループを検索し、プロジェクト×キーワードの検出結果を自身のロググループに構造化出力する

**実行方式**: EventBridge による5分間隔の定期実行

**実装上の課題（難易度: 高）**:

- CloudWatch Logs API の非同期パターン（`StartQuery` → `GetQueryResults`）
- 前回実行〜今回実行の**時間管理**（取得漏れ・重複の防止。DynamoDB や SSM Parameter Store でタイムスタンプを保存）
- API ページネーション・throttling への対応
- プロジェクト数 × キーワード数の検索を Lambda タイムアウト内に完了させる
- メトリクスフィルターが検出できる形式での出力

**検索方法の選択肢**:

| 方法 | 課金 | 適性 |
|------|------|------|
| Logs Insights | スキャンデータ量 | 集計が必要な場合に有効 |
| FilterLogEvents | API呼び出し回数のみ | ストリーム指定可能、推奨 |

### 5.2 messager Lambda

**役割**: アラーム発火時に対象ログを取得し、整形して通知する

**実行方式**: CloudWatch Alarm → SNS → Lambda（イベント駆動）

**実装上の課題（難易度: 低）**:

- SNS メッセージからアラーム名をパースし、プロジェクト・キーワードを特定
- 対象のロググループ・ストリームから過去5〜6分のログを取得（アラーム発火の遅延を考慮）
- Slack 向けの通知メッセージを整形して SNS に送信

**将来対応**: `override_log_group`（JSON設定）で取得先を切り替え可能にし、分離後も変更なしで動作させる

### 5.3 JSON 設定ファイル

```json
{
  "source_log_group": "/aws/app/shared-logs",
  "formatter_log_group": "/aws/custom/formatter-output",
  "projects": [
    {
      "name": "project-a",
      "stream_prefix": "project-a",
      "override_log_group": null,
      "monitors": [
        {
          "keyword": "ERROR",
          "severity": "critical",
          "notification_channel": "slack-critical"
        },
        {
          "keyword": "TIMEOUT",
          "severity": "warning",
          "notification_channel": "slack-warning"
        }
      ]
    }
  ]
}
```

- `override_log_group`: 分離後、プロジェクト専用ロググループを指定（`null` の場合は共有ロググループを使用）

### 5.4 メトリクスフィルター & アラーム

- **メトリクスフィルター**: formatter ロググループに「プロジェクト × キーワード」の組み合わせで設定
- **アラーム**: 閾値 ≥ 1、Period = 5分、OK → ALARM 遷移時に messager を起動
- **コスト試算**（5プロジェクト × 5キーワード = 25の場合）:
  - カスタムメトリクス: (25 - 10無料枠) × $0.30 = $4.50/月
  - アラーム: (25 - 10無料枠) × $0.10 = $1.50/月

## 6. 懸念事項と対策

| 懸念 | 対策 |
|------|------|
| Logs Insights のクエリ時間が Lambda タイムアウトを超える | `FilterLogEvents` API を推奨。並列クエリの同時実行数上限（30）にも注意 |
| formatter の取得漏れ・重複 | 前回実行タイムスタンプを DynamoDB / SSM Parameter Store に保存 |
| アラーム OK → ALARM の復帰タイミング | 連続エラー時は ALARM のまま → 2回目以降通知なし。これが許容できるか要確認 |
| メトリクス×アラームのスケーリングコスト | 規模を監視しつつ、必要に応じてキーワードの統合を検討 |
| messager がアラームからプロジェクト・キーワードを取得 | アラーム名にプロジェクト名・キーワードを含める命名規則を策定 |
| formatter の IAM 権限が広い | 最小権限に絞れるよう、ロググループ ARN を明示的に指定 |

## 7. 推奨の実装順序

```
1. messager Lambda を先に実装（簡単、動作確認が早い）
     ↓
2. 手動テストアラームで messager の動作確認
     ↓
3. formatter Lambda を実装（複雑な部分に集中）
     ↓
4. メトリクスフィルター + アラームの設定（Terraform / SAM）
     ↓
5. 結合テスト
```

## 8. 未決定事項

- [ ] デプロイ方法（SAM / Terraform / CDK）
- [ ] 現在のプロジェクト数・キーワード数の具体的な規模
- [ ] 連続エラー時の通知ポリシー（ALARM のまま → 何時間後に再通知するか）
- [ ] 既存の cloudwatch-logs-handler プロジェクトをベースにするか新規か
