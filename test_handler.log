============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0 -- /home/eric/Documents/Code/python/cloudwatch-logs-handler/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/eric/Documents/Code/python/cloudwatch-logs-handler
configfile: pyproject.toml
plugins: cov-7.0.0
collecting ... collected 3 items

tests/test_handler.py::TestHandler::test_full_flow_with_detections FAILED [ 33%]
tests/test_handler.py::TestHandler::test_disabled_project_skipped FAILED [ 66%]
tests/test_handler.py::TestHandler::test_no_detections_noop FAILED       [100%]

=================================== FAILURES ===================================
__________________ TestHandler.test_full_flow_with_detections __________________

self = <tests.test_handler.TestHandler object at 0x7fe635f9efd0>
mock_put_metric = <MagicMock name='put_metric_data' id='140626723523616'>
mock_sns = <MagicMock name='sns_publish' id='140626723524624'>
mock_filter = <MagicMock name='filter_log_events_with_pagination' id='140626723525296'>
mock_boto3 = <MagicMock name='boto3' id='140626723525632'>

    @mock_aws
    @patch("log_monitor.handler.boto3")
    @patch("log_monitor.handler.filter_log_events_with_pagination")
    @patch("log_monitor.handler.sns_publish")
    @patch("log_monitor.handler.put_metric_data")
    def test_full_flow_with_detections(
        self, mock_put_metric, mock_sns, mock_filter, mock_boto3
    ):
        """Test complete flow: detect errors → notify → update state."""
        # Set up DynamoDB
        dynamodb = boto3.resource("dynamodb", region_name="ap-northeast-1")
        table = dynamodb.create_table(
            TableName="log-monitor",
            KeySchema=[
                {"AttributeName": "pk", "KeyType": "HASH"},
                {"AttributeName": "sk", "KeyType": "RANGE"},
            ],
            AttributeDefinitions=[
                {"AttributeName": "pk", "AttributeType": "S"},
                {"AttributeName": "sk", "AttributeType": "S"},
            ],
            BillingMode="PAY_PER_REQUEST",
        )
        table.meta.client.get_waiter("table_exists").wait(TableName="log-monitor")
    
        # Insert config
        table.put_item(Item={
            "pk": "GLOBAL",
            "sk": "CONFIG",
            "source_log_group": "/aws/app/shared-logs",
            "metric_namespace": "LogMonitor",
            "max_log_lines": 20,
            "defaults": {
                "severity": "warning",
                "renotify_min": 60,
                "notify_on_recover": True,
            },
            "sns_topics": {
                "critical": "arn:aws:sns:ap-northeast-1:123456789012:critical-alerts",
                "warning": "arn:aws:sns:ap-northeast-1:123456789012:warning-alerts",
                "info": "arn:aws:sns:ap-northeast-1:123456789012:info-alerts",
            },
            "notification_template": {
                "subject": "[{severity}] {project} - {keyword}",
                "body": "{project} で {keyword} が {count}件 検出\n{log_lines}",
            },
        })
    
        table.put_item(Item={
            "pk": "PROJECT",
            "sk": "project-a",
            "display_name": "Project Alpha",
            "stream_prefix": "project-a",
            "enabled": True,
            "monitors": [
                {"keyword": "ERROR", "severity": "critical"},
            ],
        })
    
        # Mock boto3.resource to return our mocked DynamoDB
        mock_boto3.resource.return_value = dynamodb
        mock_table = MagicMock()
>       mock_boto3.resource.return_value.Table.return_value = table
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'method' object has no attribute 'return_value' and no __dict__ for setting new attributes

tests/test_handler.py:84: AttributeError
------------------------------ Captured log call -------------------------------
INFO     botocore.credentials:credentials.py:1252 Found credentials in environment variables.
__________________ TestHandler.test_disabled_project_skipped ___________________

self = <tests.test_handler.TestHandler object at 0x7fe635f9f4d0>
mock_put_metric = <MagicMock name='put_metric_data' id='140626722329264'>
mock_sns = <MagicMock name='sns_publish' id='140626723520592'>
mock_filter = <MagicMock name='filter_log_events_with_pagination' id='140626702413040'>
mock_boto3 = <MagicMock name='boto3' id='140626687713904'>

    @mock_aws
    @patch("log_monitor.handler.boto3")
    @patch("log_monitor.handler.filter_log_events_with_pagination")
    @patch("log_monitor.handler.sns_publish")
    @patch("log_monitor.handler.put_metric_data")
    def test_disabled_project_skipped(
        self, mock_put_metric, mock_sns, mock_filter, mock_boto3
    ):
        """Disabled projects should be completely skipped."""
        dynamodb = boto3.resource("dynamodb", region_name="ap-northeast-1")
        table = dynamodb.create_table(
            TableName="log-monitor",
            KeySchema=[
                {"AttributeName": "pk", "KeyType": "HASH"},
                {"AttributeName": "sk", "KeyType": "RANGE"},
            ],
            AttributeDefinitions=[
                {"AttributeName": "pk", "AttributeType": "S"},
                {"AttributeName": "sk", "AttributeType": "S"},
            ],
            BillingMode="PAY_PER_REQUEST",
        )
        table.meta.client.get_waiter("table_exists").wait(TableName="log-monitor")
    
        table.put_item(Item={
            "pk": "GLOBAL",
            "sk": "CONFIG",
            "source_log_group": "/aws/app/shared-logs",
            "metric_namespace": "LogMonitor",
            "max_log_lines": 20,
            "defaults": {"severity": "warning", "renotify_min": 60, "notify_on_recover": True},
            "sns_topics": {
                "critical": "arn:aws:sns:...:critical",
                "warning": "arn:aws:sns:...:warning",
                "info": "arn:aws:sns:...:info",
            },
            "notification_template": {"subject": "sub", "body": "body"},
        })
    
        table.put_item(Item={
            "pk": "PROJECT",
            "sk": "project-disabled",
            "display_name": "Disabled Project",
            "stream_prefix": "disabled",
            "enabled": False,
            "monitors": [{"keyword": "ERROR", "severity": "critical"}],
        })
    
        mock_boto3.resource.return_value = dynamodb
>       mock_boto3.resource.return_value.Table.return_value = table
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'method' object has no attribute 'return_value' and no __dict__ for setting new attributes

tests/test_handler.py:163: AttributeError
------------------------------ Captured log call -------------------------------
INFO     botocore.credentials:credentials.py:1252 Found credentials in environment variables.
_____________________ TestHandler.test_no_detections_noop ______________________

self = <tests.test_handler.TestHandler object at 0x7fe635f4f820>
mock_put_metric = <MagicMock name='put_metric_data' id='140626687716592'>
mock_sns = <MagicMock name='sns_publish' id='140626687717264'>
mock_filter = <MagicMock name='filter_log_events_with_pagination' id='140626687717936'>
mock_boto3 = <MagicMock name='boto3' id='140626687718272'>

    @mock_aws
    @patch("log_monitor.handler.boto3")
    @patch("log_monitor.handler.filter_log_events_with_pagination")
    @patch("log_monitor.handler.sns_publish")
    @patch("log_monitor.handler.put_metric_data")
    def test_no_detections_noop(
        self, mock_put_metric, mock_sns, mock_filter, mock_boto3
    ):
        """No detections and status=OK → NOOP, no notifications."""
        dynamodb = boto3.resource("dynamodb", region_name="ap-northeast-1")
        table = dynamodb.create_table(
            TableName="log-monitor",
            KeySchema=[
                {"AttributeName": "pk", "KeyType": "HASH"},
                {"AttributeName": "sk", "KeyType": "RANGE"},
            ],
            AttributeDefinitions=[
                {"AttributeName": "pk", "AttributeType": "S"},
                {"AttributeName": "sk", "AttributeType": "S"},
            ],
            BillingMode="PAY_PER_REQUEST",
        )
        table.meta.client.get_waiter("table_exists").wait(TableName="log-monitor")
    
        table.put_item(Item={
            "pk": "GLOBAL",
            "sk": "CONFIG",
            "source_log_group": "/aws/app/shared-logs",
            "metric_namespace": "LogMonitor",
            "max_log_lines": 20,
            "defaults": {"severity": "warning", "renotify_min": 60, "notify_on_recover": True},
            "sns_topics": {
                "critical": "arn:aws:sns:...:critical",
                "warning": "arn:aws:sns:...:warning",
                "info": "arn:aws:sns:...:info",
            },
            "notification_template": {"subject": "sub", "body": "body"},
        })
    
        table.put_item(Item={
            "pk": "PROJECT",
            "sk": "project-a",
            "display_name": "Project Alpha",
            "stream_prefix": "project-a",
            "enabled": True,
            "monitors": [{"keyword": "ERROR", "severity": "critical"}],
        })
    
        mock_boto3.resource.return_value = dynamodb
>       mock_boto3.resource.return_value.Table.return_value = table
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'method' object has no attribute 'return_value' and no __dict__ for setting new attributes

tests/test_handler.py:220: AttributeError
------------------------------ Captured log call -------------------------------
INFO     botocore.credentials:credentials.py:1252 Found credentials in environment variables.
=========================== short test summary info ============================
FAILED tests/test_handler.py::TestHandler::test_full_flow_with_detections - A...
FAILED tests/test_handler.py::TestHandler::test_disabled_project_skipped - At...
FAILED tests/test_handler.py::TestHandler::test_no_detections_noop - Attribut...
============================== 3 failed in 0.53s ===============================
