# cloudwatch-logs-handler

今回は日本語でやってみる

## Situation

AWS上で一つのアカウントに複数のプロジェクトがあり、そのプロジェクトたちがログを同じロググループに出力している

ログストリーム名にはプロジェクトの識別子があるが、それ以外何もない

各プロジェクトでそれぞれ特別なログを監視したい

## Target

- Lambda（Python）でログ監視の実現したい
- 一つのLambdaで複数のプロジェクトの監視キーワードを対応したい
- 検知したログをAWS SNS -> Chatbow -> Slackで通知したい
- 通知内容をカスタマイズしたい
- 通知先をカスタマイズしたい
- 検知に関する設定をJSONで管理したい

## Design

- 一つのLambda(formatter)で既存のロググループを整理し、プロジェクトごとのキーワード検出数を自分のロググループに出力
- formatterはcloudwatch logs queryとかで検出結果を取得
- formatterはコストパフォーマンスを考慮し、５分間隔で定期実行
- formatterのロググループにメトリクスフィルターを設定し、プロジェクト：キーワードのK:Vでたくさんのメトリクスフィルターを設定し、そのメトリクスフィルターでアラームを設定
- アラームで閾値を1に設定し、アラーム状態になったらもう一つのLambda(messager)を起動し、対象K:Vで過去5分間のログを取得し、SNS　-> Chatbot -> Slackに通知する
- この構成図も書いてほしい
